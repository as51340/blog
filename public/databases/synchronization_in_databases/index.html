<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Synchronizing data access in databases | Andi Skrgat</title>
<meta name="keywords" content="" />
<meta name="description" content="Databases expose their data in a parallel way to multiple users. However, synchronization must occur so that in every moment of its lifespan, the database&#39;s state is consistent.">
<meta name="author" content="Andi Skrgat">
<link rel="canonical" href="https://as51340.github.io/blog/databases/synchronization_in_databases/" />
<link crossorigin="anonymous" href="/blog/assets/css/stylesheet.min.7bfe087ae72df31787ec7a1360dd05ee246a179b51cf7a30a904b39d7f813b69.css" integrity="sha256-e/4Ieuct8xeH7HoTYN0F7iRqF5tRz3owqQSznX&#43;BO2k=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/blog/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://as51340.github.io/images/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://as51340.github.io/images/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://as51340.github.io/images/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://as51340.github.io/images/apple-touch-icon.png">
<link rel="mask-icon" href="https://as51340.github.io/images/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://as51340.github.io/blog/" accesskey="h" title="Andi Skrgat (Alt + H)">Andi Skrgat</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/blog" title="Home"><span>Home</span></a>
            </li>
            <li>
                <a href="https://as51340.github.io/blog/databases/" title="Databases">
                    <span>Databases</span>
                </a>
            </li>
            <li>
                <a href="https://as51340.github.io/blog/football/" title="Football">
                    <span>Football</span>
                </a>
            </li>
            <li>
                <a href="https://as51340.github.io/blog/about/" title="About me">
                    <span>About me</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://as51340.github.io/blog/">Home</a>&nbsp;»&nbsp;<a href="https://as51340.github.io/blog/databases/">Articles</a></div>
    <h1 class="post-title">
      Synchronizing data access in databases
    </h1>
    <div class="post-description">
      Databases expose their data in a parallel way to multiple users. However, synchronization must occur so that in every moment of its lifespan, the database&#39;s state is consistent.
    </div>
    <div class="post-meta">4 min&nbsp;·&nbsp;Andi Skrgat</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#latches-vs-locks" aria-label="Latches vs. locks">Latches vs. locks</a></li>
                <li>
                    <a href="#what-are-latches-preferred-properties" aria-label="What are latches&#39; preferred properties?">What are latches' preferred properties?</a><ul>
                        
                <li>
                    <a href="#spinlock" aria-label="Spinlock">Spinlock</a></li>
                <li>
                    <a href="#mutex" aria-label="Mutex">Mutex</a></li>
                <li>
                    <a href="#adaptive-spinlock" aria-label="Adaptive Spinlock">Adaptive Spinlock</a></li>
                <li>
                    <a href="#queue-based-spinlock" aria-label="Queue-based Spinlock">Queue-based Spinlock</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content">
  <h2 id="latches-vs-locks">Latches vs. locks</h2>
<p>Latches and locks are often interchangeably used to describe the synchronization scheme of a database. However, there are subtle differences in their usage. Locks are preferred when talking about users' interaction with the database through transactions. For example, locks as such are used in implementing waits-for-graph in deadlock detection, in transaction abort (full or partial) and in transaction timeout. On the other side, latches are used for ensuring consistency in parallel data structures which constitute the core of the database&rsquo;s storage engine. In most relational databases this is some variant of a B-Tree but choices are various, from deterministic data structures up to randomized ones like the skip list.</p>
<h2 id="what-are-latches-preferred-properties">What are latches' preferred properties?</h2>
<p>Although latches are primarily used to protect critical sections of the code to provide consistency of a data structure, the basic thing we would like from our latch is that it doesn&rsquo;t slow down the execution path in situations when threads don&rsquo;t create high contention in a system. This is very important because, in parallel systems, the number of execution paths that a system with multiple threads can take is very high. For example, I read in the book Clean Code by Uncle Bob that the following <code>getNextId</code> function can take 12870 execution paths when executed by only two threads (didn&rsquo;t get into details why).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">X</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">lastIdUsed</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getNextId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">++</span><span class="n">lastIdUsed</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">};</span>
</code></pre></div><p>The second thing we would like from latches is that it doesn&rsquo;t take a lot of memory because (for B-Tree) every node needs to have its latch. Now if <code>pthread_mutex_t</code> is used, which is of size 64B, this can be quite costly. (In c++ <code>std::mutex</code> is implemented using <code>pthread_mutex_t</code> ) And also as a side note, the latch is usually a part of the node struct (or class) to reduce the cost of ensuring cache coherence.</p>
<h3 id="spinlock">Spinlock</h3>
<p>There are various implementations of a spinlock and many different optimizations and ideas that one can use to implement a spinlock but the core concept behind a spinlock is that it performs so-called &ldquo;busy waiting&rdquo;. So if one thread acquired the right to use some object (node in a B-Tree example), the other thread spins in a loop testing whether the object is available. Such an approach is viable only when locks are held shortly by each thread since there is no OS involvement, otherwise, it is too costly to spend CPU time.</p>
<h3 id="mutex">Mutex</h3>
<p>Mutex addresses the problem of a &ldquo;busy loop&rdquo; with the help of OS. The underlying operating system will deschedule the thread and avoid unnecessary CPU work time by waking the waiting thread once the resource becomes available. However, pure mutex has also a big performance cost since thread deschedulation and waking are expensive operations (around 25ns). However, if I am not wrong, most modern systems use some kind of a hybrid scheme which allows the thread to first spin for some time and then go to sleep if the resource is still not available therefore trying to make some kind of a compromise between two solutions.</p>
<h3 id="adaptive-spinlock">Adaptive Spinlock</h3>
<p>Adaptive spinlock uses also a hybrid scheme but improves in a way that the thread doesn&rsquo;t get descheduled from OS but rather stored in a &ldquo;parking lot&rdquo;. The trick is that such a &ldquo;parking lot&rdquo; is not managed by OS so it is much faster than a pure mutex. I know about Apple&rsquo;s WTF::ParkingLot but am not aware of anything else.</p>
<h3 id="queue-based-spinlock">Queue-based Spinlock</h3>
<p>Queue-based Spinlock is used in the Linux kernel at multiple places. It improves the basic spinlock and the standard mutex in a way that when the thread cannot acquire the resource, it saves &ldquo;the pointer&rdquo; to the thread which currently holds the resource so that the resource is available, it can get notified very fast without big overhead.</p>
<p>In this blog post, I only scratched the surface locks and latches in the world of databases. Let me know about any comments, suggestions, corrections 🫡.</p>
<p>NOTE: The majority of materials are taken from Andy Pavlo&rsquo;s lectures from CMU.</p>

  </div>

  <footer class="post-footer">

<div class="share-buttons">

    <a target="_blank" rel="noopener noreferrer" aria-label="share Synchronizing data access in databases on linkedin"
        href="https://www.linkedin.com/in/andi-skrgat-658b471b8/">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
</div>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span> built with ♥ from charlola
      
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>


<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
